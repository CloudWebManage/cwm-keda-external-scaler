name: ci

on:
  push:
    paths-ignore:
    - '**.md'
  pull_request:
    paths-ignore:
    - '**.md'

jobs:
  test-and-publish:
    name: Build, test and publish
    runs-on: ubuntu-18.04

    steps:
    - uses: actions/checkout@v2

    - name: Setup
      run: |
        sudo ./test/setup.sh

    - name: Test
      run: |
        ./test/run_scaling_tests.sh

    - name: Teardown
      run: |
        ./test/teardown.sh

    - name: Publish
      if: github.ref == 'refs/heads/main'
      env:
        USERNAME: ${{ github.actor }}
        PASSWORD: ${{ github.token }}
        REPO: ${{ github.repository }}
      run: |
        ./bin/push_docker_image.sh
